<div *ngIf="(closingProcedure$ | async) as closingProcedures"></div>


<mat-card *ngIf="(uiTransactions$ | async) as uiTransactions">

  <mat-card-title></mat-card-title>
  <mat-card-subtitle>
    POS Operations
  </mat-card-subtitle>

  <mat-card-content>
    <span>
      <button mat-raised-button (click)="refreshInfo()"><mat-icon>refresh</mat-icon>
      Refresh Sales Reports</button>
    </span>

    <span>
      <button mat-raised-button (click)="closeDay()">Close Day</button>
    </span>

    <span *ngIf="(printAction$ | async) as action">
      <button mat-raised-button (click)="print(action)"> <mat-icon>print</mat-icon>Print</button>
    </span>

    <span>
      <button mat-raised-button (click)="email()"> <mat-icon>email</mat-icon>Email</button>
    </span>

    <span *ngIf="(uiTransactions && uiTransactions.dsiEMVNeteEpayEnabled) && dsiEMVSettings && isElectronApp">
      <button mat-raised-button (click)="emvDatacapBatchCards()"> <mat-icon>credit_card</mat-icon>Batch Close</button>
    </span>

    <span *ngIf="(uiTransactions && uiTransactions.dsiEMVNeteEpayEnabled) && dsiEMVSettings && isElectronApp">
      <button mat-raised-button (click)="emvDataCapBatchInquire()"> <mat-icon>credit_card</mat-icon>Batch Inquire</button>
    </span>

    <app-list-printers-electron
        [printerName]      ="printerName"
        (outputPrinterName)="setPrinter($event)" >
      Receipt Printer
    </app-list-printers-electron>

    <span *ngIf="runningClose">
      <mat-spinner [diameter]="25" class="spinner"></mat-spinner>
    </span>
    <span *ngIf="balanceSheetsClosed">
      {{balanceSheetsClosed}}.
    </span>
    <span *ngIf="closeResult">
      {{closeResult}}
    </span>

    <div *ngIf="batchSummary  && isElectronApp">
      <mat-card>
        <mat-card-subtitle>Batch Inquire</mat-card-subtitle>
        <div class="grid-container" >
          <div>Batch No</div>
          <div>{{batchSummary?.BatchNo}}</div>
          <div>Net Batch Total</div>
          <div>{{batchSummary?.NetBatchTotal}}</div>
          <div>Batch Item Count</div>
          <div>{{batchSummary?.BatchItemCount}}</div>
        </div>
      </mat-card>
    </div>

    <div  *ngIf="batchClose  && isElectronApp">
      <mat-card>
        <mat-card-subtitle>Bath close summary</mat-card-subtitle>
        <div class="grid-container">
          <div>Batch No</div>
          <div>{{batchClose?.BatchNo}}</div>
          <div>Net Batch Total</div>
          <div>{{batchClose?.NetBatchTotal | currency}}</div>
          <div>Batch Item Count</div>
          <div>{{batchClose?.BatchItemCount}}</div>
        </div>
      </mat-card>
    </div>

    <div *ngIf="(email$ | async) as item; emailing"></div>
    <ng-template #emailing>
      <div *ngIf="emailSending">
        <mat-spinner [diameter]="50"></mat-spinner>
        ...emailing
      </div>
    </ng-template>

    <div *ngIf="closingCheck$ | async as closing">
      <div>
        <close-day-validation
          [closeDayValidation]="closing">
        </close-day-validation>
      </div>
    </div>

    <mat-divider></mat-divider>
  </mat-card-content>

</mat-card>

<div class="mat-divider">
  <!-- <mat-divider></mat-divider> -->
</div>

<div *ngIf="iBalanceSheet"
     class="grid-sales-cards">
  <mat-card>
    <mat-card-content>
      <div class="grid-sales-cards ">
        <div>
          <div>
            Start {{iBalanceSheet.startTime | date: 'short'}}
          </div>
          <div>
            ID {{iBalanceSheet.id}}
          </div>
        </div>
      </div>
    </mat-card-content>
  </mat-card>
</div>

<div class="container">
  <div  class="grid-sales-cards"
        *ngIf="iBalanceSheet && localSite">

    <div #printsection>
      <mat-card class="summary">
        <mat-card-content>
          <ng-container [ngTemplateOutlet]="pendingTransactions"></ng-container>
          <ng-container [ngTemplateOutlet]="futureTransactions"></ng-container>
        </mat-card-content>
      </mat-card>
  
      <ng-container [ngTemplateOutlet]="taxReport"></ng-container>

      <ng-container [ngTemplateOutlet]="paymentReport"></ng-container>

      <ng-container [ngTemplateOutlet]="balanceSheetView"></ng-container>

      <div *ngIf="!printing">
        <ng-container [ngTemplateOutlet]="employeeOrdersByHourReport"></ng-container>
      </div>

     <ng-container [ngTemplateOutlet]="salesByDevice"></ng-container>

      <ng-container [ngTemplateOutlet]="employeeReport"></ng-container>

      <ng-container [ngTemplateOutlet]="giftCardReport"></ng-container> 

    </div>

    <div>

      <ng-container [ngTemplateOutlet]="itemSalesReport"></ng-container>

      <ng-container [ngTemplateOutlet]="itemAdjustmentVoids"></ng-container> 

    </div>
  </div>

  <div
      class="section-gap"
      fxLayout="row"
      fxLayoutAlign="space-between center"
      flLayoutGap="20px">
    <mat-card *ngIf="iBalanceSheet && iBalanceSheet.startTime" class="mat-card" fxFlex="100">
        <app-widget-card [dateFrom]  ="iBalanceSheet.startTime"
                         [dateTo]    ="iBalanceSheet.startTime"
                         [zrunID]    ="iBalanceSheet.id"
                         [site]      ='localSite'
                         groupBy     ="orderemployeecount"
                         chartName   ="Employee Order Count"
          ></app-widget-card>
    </mat-card>
  </div>

</div>

<ng-template #balanceSheetView>
  <balance-sheet-report
      [site]="localSite"
      [dateFrom]="dateFrom"
      [dateTo]="dateTo"
      [zrunID]="iBalanceSheet.id" >
  </balance-sheet-report>
</ng-template>

<ng-template #pendingTransactions>
  <div class="summary" >
    <sales-tax-report
          [site]="localSite"
          [dateFrom]="dateFrom"
          [dateTo]="dateTo"
          [pendingTransactions]="true"
          [summaryOnly]="true"
          [zrunID]="iBalanceSheet.id" >
        <div summary>
          <mat-icon >receipt</mat-icon>  Pending Transactions
        </div>
    </sales-tax-report>
  </div>
</ng-template>

<ng-template #futureTransactions>
  <div class="summary" *ngIf="scheduleDateStart && scheduleDateEnd">
    <sales-tax-report
          [site]="localSite"
          [scheduleDateStart]="scheduleDateStart"
          [scheduleDateEnd]="scheduleDateEnd"
          [pendingTransactions]="true"
          [summaryOnly]="true"
         >
          <div summary>
             <mat-icon >receipt</mat-icon> Next 30 Days
          </div>
    </sales-tax-report>
  </div>
</ng-template>


<ng-template #taxReport>
  <div>
    <sales-tax-report
          [site]="localSite"
          [dateFrom]="dateFrom"
          [dateTo]="dateTo"
          [zrunID]="iBalanceSheet.id" >
        <mat-icon>receipt</mat-icon>  Sales
        <mat-divider></mat-divider>
    </sales-tax-report>
  </div>
</ng-template>

<ng-template #paymentReport>
  <payment-report
      [site]    ="localSite"
      [dateFrom]="dateFrom"
      [dateTo]  ="dateTo"
      [zrunID]  ="iBalanceSheet.id"
      [groupBy] ="'paymentMethod'"
      [type]    ="'sales'"
      >
    <div class="header">
      <mat-icon>credit_card</mat-icon>  Payment Methods
      <mat-divider></mat-divider>
    </div>
  </payment-report>
</ng-template>

<ng-template #discountReport>
</ng-template>

<ng-template #salesByDevice>
  <payment-report
    [groupBy]="'devicename'"
    [site]    ="site"
    [dateFrom]="dateFrom"
    [dateTo]  ="dateTo"
    [zrunID]  ="iBalanceSheet.id"
  >
  <mat-icon>credit_card</mat-icon> Devices - {{site.name}}
  </payment-report>
</ng-template>

<ng-template #employeeOrdersByHourReport>
  <payment-report
    [site]    ="localSite"
    [dateFrom]="dateFrom"
    [dateTo]  ="dateTo"
    [zrunID]  ="iBalanceSheet.id"
    [groupBy]="'orderEmployeeCount'">
    <mat-icon>people_alt</mat-icon> Employee Orders By Hour
  </payment-report>
</ng-template>

<ng-template #employeeReport>
  <payment-report
      [site]    ="localSite"
      [dateFrom]="dateFrom"
      [dateTo]  ="dateTo"
      [zrunID]  ="iBalanceSheet.id"
      [groupBy] ="'employee'"
      >
    <mat-icon>people</mat-icon>  Employee Sales
    <mat-divider></mat-divider>
  </payment-report>
</ng-template>

<ng-template #giftCardReport>
  <item-sales-card
      [site]="localSite"
      [dateFrom]="dateFrom"
      [dateTo]="dateTo"
      [zrunID]="iBalanceSheet.id"
      [removeGiftCard]="false"
      [viewType] = "'sales'"
      [groupBy]="'items'">
    <div class="header">
      <mat-icon>menu</mat-icon>  Gift Card / Store Credit Issuances
      <mat-divider></mat-divider>
    </div>
  </item-sales-card>
</ng-template>

<ng-template #itemSalesReport>
  <item-sales-card
      [site]="localSite"
      [dateFrom]="dateFrom"
      [dateTo]="dateTo"
      [zrunID]="iBalanceSheet.id"
      [removeGiftCard]="true"
      [viewType] = "'sales'"
      [groupBy]="'items'">
      <div class="header">
        <h4>  <mat-icon>menu</mat-icon> Items </h4>
        <mat-divider></mat-divider>
      </div>
  </item-sales-card>
</ng-template>

<ng-template #itemAdjustmentVoids>
  <div>
    <item-sales-card
          [site]    ="site"
          [dateFrom]="dateFrom"
          [dateTo]  ="dateTo"
          [removeGiftCard]="true"
          [groupBy]  = "'void'"
          [viewType] = "'adjustment'"
          [zrunID]="iBalanceSheet.id"
          >
        <div class="header">
          <mat-icon>menu</mat-icon> Item Voids
          <mat-divider></mat-divider>
        </div>
    </item-sales-card>
  </div>
</ng-template>

