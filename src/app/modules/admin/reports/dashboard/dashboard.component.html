<div  class="container" *ngIf="(uiTransactions$ | async) as value">

  <ng-container *ngTemplateOutlet="headerView"></ng-container>

  <div *ngIf="(email$ | async) as email; else emailing"></div>

  <ng-container *ngTemplateOutlet="customReportView"></ng-container>

  <br> <mat-divider  class="section-gap"></mat-divider> <br>

  <ng-container *ngTemplateOutlet="reportsView"></ng-container>

  <ng-template #loadingSites>.... loading</ng-template>
</div>

<ng-template #headerView>
  <div class="grid-buttons">
    <div *ngIf="completionDateForm">
      <mat-date-range
        [hideRefresh]="true"
        [inputForm] ="completionDateForm">
      </mat-date-range>
    </div>

    <div>
      <button mat-raised-button
              style="margin-top: 10px"
              color="primary"
              (click)="refreshReports()">
        <span *ngIf="largeDevice">Refresh</span>
        <span *ngIf="!largeDevice"><mat-icon>refresh</mat-icon></span>
      </button>
    </div>

    <div>
      <button mat-raised-button
              style="margin-top: 10px"
              color="primary"
              (click)="email()">
        Email <mat-icon>email</mat-icon>
      </button>
    </div>

    <div>
      <button mat-raised-button
              color="accent"
              style="margin-top: 10px"
              (click)="toggleShowValues()">
        <span *ngIf="showValues">
          <mat-icon color="primary">analytics</mat-icon>Hide List Reports
        </span>
      </button>
    </div>

    <ng-container [ngTemplateOutlet]="designReportButtonView"></ng-container>
  </div>

  <ng-template #designReportButton>
    <div *ngIf="largeDevice">
      <button mat-raised-button
              color="primary"
              style="margin-top: 10px"
              (click)="navDesigner()">
          <mat-icon>list</mat-icon>Design (beta)
      </button>
    </div>
  </ng-template>

  <div class="topics">

    <h3><mat-icon>list</mat-icon>Report Types</h3>
      <ng-container [ngTemplateOutlet]="reportCategoriesView"></ng-container>

      <ng-template #reportCategoriesList>
        <mat-form-field appearance="outline">
          <mat-label>Select</mat-label>
          <mat-select  (selectionChange)="toggleReports($event.value)">
            <mat-option *ngFor="let item of reportGroupList"
                        [value]="item.value">
              {{item.name}}
            </mat-option>
          </mat-select>
        </mat-form-field>
      </ng-template>

      <ng-template #reportCategories>
        <div class="ps-flex-group">
           <div>
            <button mat-flat-button
                    style="width:205px;height:50px"
                    color="primary"
                    (click)="toggleReports('financials')">
            <mat-icon>money</mat-icon>Financials</button>
          </div>
          <div>
            <button mat-flat-button
                    style="width:205px;height:50px"
                    color="primary"
                    (click)="toggleReports('items')">
            <mat-icon>products</mat-icon>Products & Services</button>
          </div>
          <div>
            <button mat-flat-button
                    style="width:205px;height:50px"
                    color="primary"
                    (click)="toggleReports('output')">
            <mat-icon>inventory</mat-icon>Inventory & Menu</button>
          </div>
          <div>
            <button mat-flat-button
                    style="width:205px;height:50px"
                    color="primary"
                    (click)="toggleReports('audit')">
            <mat-icon>inventory</mat-icon>Audit</button>
          </div>
        </div>
      </ng-template>
    <mat-divider></mat-divider>
  </div>

  <div *ngIf="displayReports == 'items'">

    <div *ngIf="!largeDevice">
      <ng-container [ngTemplateOutlet]="itemReportButtonsSmall" ></ng-container>
    </div>

    <div *ngIf="largeDevice">
      <ng-container [ngTemplateOutlet]="itemReportButtons" ></ng-container>
    </div>

    <ng-template #itemReportButtons>
      <div class="ps-flex-group">
        <div>
          <button mat-flat-button
                 *ngFor="let item of itemReportList"
                  style="width:150px;height:50px" color="primary"
                  (click)="showView(item.id)">{{item.name}}</button>
        </div>
      </div>
    </ng-template>

    <ng-template #itemReportButtonsSmall>
      <mat-form-field appearance="outline">
        <mat-label>Select</mat-label>
        <mat-select  (selectionChange)="showView($event.value)">
          <mat-option *ngFor="let item of itemReportList"
                      [value]="item.id">
            {{item.name}}
          </mat-option>
        </mat-select>
      </mat-form-field>
    </ng-template>
  </div>

  <div [hidden]="displayReports != 'output'">
    <ng-container [ngTemplateOutlet]="reportDesignerOutPutView" ></ng-container>
    <ng-template #reportDesigner>
      <h3>Output Reports</h3>
      <div *ngIf="reportDesignerForm">
        <app-mat-select [list]     ="reportList"
                        [inputForm]="reportDesignerForm"
                        [fieldName]="'field'"
                        [hideClear]="true"
                        (outputItem)="selectReport($event)">
            Select Report
        </app-mat-select>
      </div>
    </ng-template>
  </div>

  <div [hidden]="displayReports != 'audit' ">
    <div>
      <button mat-flat-button  style="width:150px;height:50px"color="warn"
              (click)="showView(8)">Payment Voids</button>
      <button mat-flat-button  style="width:150px;height:50px"color="warn"
              (click)="showView(7)">Payment Refunds</button>
      <button mat-flat-button  style="width:150px;height:50px"color="warn"
              (click)="showView(5)">Item Voids</button>
    </div>
  </div>

</ng-template>

<ng-template #customReport>
    <div>
      <button mat-raised-button
              (click)="clearCustomData()">
        Clear </button>
    </div>

    <div *ngIf="(dynamicData$ | async) as data; else loadingData">
      <dynamic-ag-grid [dataInterface]="'ReOrderList'"
                      [data]="data">
      </dynamic-ag-grid>
    </div>

    <ng-template #loadingData>
      <div *ngIf="loadDynamicData">
        ...loading data.
        <mat-spinner [diameter]="50"></mat-spinner>
      </div>
    </ng-template>
</ng-template>

<ng-template #reportsView>

  <div class="grid-flow" *ngIf="sites && showValues && dateFrom && dateTo">
    <div  *ngFor="let site of sites">
      <div style="margin-left:15px;width:350px;">
        <div style="text-align: center;">
            <h4 color='primary' ><mat-icon color='primary'>store</mat-icon>
            <span style="margin-left:15px" color='primary'>{{site.name}}</span> </h4>
            <mat-divider></mat-divider>
        </div>
      </div>

      <div [hidden]="displayReports != 'financials'">
        <div class="summary">
          <ng-container *ngTemplateOutlet="viewMetrcNetSales, context: {$implicit: site}">
          </ng-container>
        </div>

        <sales-tax-report
                [site]="site"
                [dateFrom]="dateFrom"
                [dateTo]="dateTo"
                [minimized]="'true'"
                [notifier]="childNotifier">
          <div header>
            <mat-icon >summarize</mat-icon> Sales - {{site.name}}
          </div>
          <mat-icon>summarize</mat-icon> Sales - {{site.name}}
        </sales-tax-report>


        <payment-report
                [site]    ="site"
                [dateFrom]="dateFrom"
                [dateTo]  ="dateTo"
                [notifier]="childNotifier">
          <div header>
            <mat-icon >summarize</mat-icon> Payments - {{site.name}}
          </div>
          <mat-icon>credit_card</mat-icon> Payments - {{site.name}}
        </payment-report>

        <payment-report
                [groupBy]="'service'"
                [site]    ="site"
                [dateFrom]="dateFrom"
                [dateTo]  ="dateTo"
                [notifier]="childNotifier">
          <div header>
            <mat-icon >summarize</mat-icon> Sale Type - {{site.name}}
          </div>
          <mat-icon>credit_card</mat-icon> Sale Type - {{site.name}}
        </payment-report>

        <ng-container *ngTemplateOutlet="balanceSheetView,
                                        context: {$implicit: {site: site}}">
        </ng-container>

        <ng-template #balanceSheetView>
          <balance-sheet-report
              [site]="site"
              [dateFrom]="dateFrom"
              [dateTo]="dateTo"
              [notifier]="childNotifier"
              >
          </balance-sheet-report>
        </ng-template>

        <payment-report
                [groupBy]="'deviceName'"
                [site]    ="site"
                [dateFrom]="dateFrom"
                [dateTo]  ="dateTo"
                [notifier]="childNotifier">
          <div header>
            <mat-icon >summarize</mat-icon> Devices - {{site.name}}
          </div>
          <mat-icon>credit_card</mat-icon> Devices - {{site.name}}
        </payment-report>

      </div>

      <div [hidden]="displayReports != 'audit'">

        <ng-container *ngTemplateOutlet="paymentVoidsView,context:
                      {$implicit: site}"></ng-container>
        <ng-template #paymentVoids let-site>
          <payment-report
                  [groupBy]="'deviceName'"
                  [site]    ="site"
                  [dateFrom]="dateFrom"
                  [dateTo]  ="dateTo"
                  [notifier]="childNotifier"
                  [type]="'voids'"
                  >
            <div header>
              <mat-icon >summarize</mat-icon> Void Payments {{site.name}}
            </div>
            <mat-icon>credit_card</mat-icon> Void Payments {{site.name}}
          </payment-report>
        </ng-template>

        <ng-container *ngTemplateOutlet="paymentRefundsView,context:
                                        {$implicit: site}"></ng-container>
        <ng-template #paymentRefunds let-site>
          <payment-report
                  [groupBy]="'deviceName'"
                  [site]    ="site"
                  [dateFrom]="dateFrom"
                  [dateTo]  ="dateTo"
                  [notifier]="childNotifier"
                  [type]="'refunds'"
                  >
            <div header>
              <mat-icon >summarize</mat-icon> Refund Payments {{site.name}}
            </div>
            <mat-icon>credit_card</mat-icon> Refund Payments {{site.name}}
          </payment-report>
        </ng-template>

        <ng-container *ngTemplateOutlet="itemVoidsView,context: {$implicit: site}"></ng-container>
        <ng-template #itemVoids let-site>
          <div>
            <item-sales-card
                  [site]="site"
                  [dateFrom]="dateFrom"
                  [dateTo]="dateTo"
                  [removeGiftCard]="true"
                  [groupBy]  = "'void'"
                  [viewType] = "'adjustment'"
                  >
                <div class="header">
                  <mat-icon>menu</mat-icon>  Item Voids
                  <mat-divider></mat-divider>
                </div>
            </item-sales-card>
          </div>
        </ng-template>
      </div>

      <div [hidden]="displayReports != 'items'">
        <h3>{{site?.name}}</h3>
        <ng-container *ngTemplateOutlet="categorySalesView,context: {$implicit: site}"></ng-container>
        <ng-template #categorySales let-site>
          <div>
            <item-sales-card
                  [site]="site"
                  [dateFrom]="dateFrom"
                  [dateTo]="dateTo"
                  [removeGiftCard]="true"
                  [viewType] = "'sales'"
                  [groupBy]="'category'">
                <div class="header">
                  <mat-icon>menu</mat-icon>  Category Sales
                  <mat-divider></mat-divider>
                </div>
            </item-sales-card>
          </div>
        </ng-template>

        <ng-container *ngTemplateOutlet="taxedCategorySalesView,context: {$implicit: site}"></ng-container>
        <ng-template #taxedCategorySales let-site>
          <div>
            <item-sales-card
                  [site]="site"
                  [dateFrom]="dateFrom"
                  [dateTo]="dateTo"
                  [removeGiftCard]="true"
                  [viewType] = "'sales'"
                  [taxFilter]="2"
                  [groupBy]="'category'">
                <div class="header">
                  <mat-icon>menu</mat-icon> Taxed Category Sales
                  <mat-divider></mat-divider>
                </div>
            </item-sales-card>
          </div>
        </ng-template>

        <ng-container *ngTemplateOutlet="nonTaxedCategorySalesView,context: {$implicit: site}"></ng-container>
        <ng-template #nonTaxedCategorySales let-site>
          <div>
            <item-sales-card
                  [site]="site"
                  [dateFrom]="dateFrom"
                  [dateTo]="dateTo"
                  [removeGiftCard]="true"
                  [viewType] = "'sales'"
                  [taxFilter]="1"
                  [groupBy]="'category'">
                <div class="header">
                  <mat-icon>menu</mat-icon> Non Taxed Category Sales
                  <mat-divider></mat-divider>
                </div>
            </item-sales-card>
          </div>
        </ng-template>

        <ng-container *ngTemplateOutlet="itemSalesView,context: {$implicit: site}"></ng-container>
        <ng-template #itemSales let-site>
          <div>
            <item-sales-card
                  [site]="site"
                  [dateFrom]="dateFrom"
                  [dateTo]="dateTo"
                  [removeGiftCard]="true"
                  [viewType] = "'sales'"
                  [groupBy]="'items'">
                <div class="header">
                  <mat-icon>menu</mat-icon> Item Sales
                  <mat-divider></mat-divider>
                </div>
            </item-sales-card>
          </div>
        </ng-template>
      </div>
    </div>
  </div>


  <div *ngIf="dateFrom && dateTo">
    <div class="grid-charts">
      <div>
        <app-widget-card
          [dateFrom] ="dateFrom"
          [dateTo]   ="dateTo"
          groupBy    ="date"
          chartName  ="ByDate"
          [sites]    ="sites"
          [counter]  ="count+1"
          [notifier]="childNotifier"
        ></app-widget-card>
      </div>

      <div>
        <app-widget-card
          [dateFrom]="dateFrom"
          [dateTo]   ="dateFrom"
          groupBy    ="hour"
          chartName  ="Hourly"
          [sites]    ="sites"
          [counter]  ="count+1"
          [notifier]="childNotifier"
        ></app-widget-card>
      </div>

      <div>
        <app-widget-card
          [dateFrom] ="dateFrom"
          [dateTo]   ="dateTo"
          groupBy    ="orderemployeecount"
          chartName  ="Employee Order Count"
          [sites]    ="sites"
          [counter]  ="count+1"
          [notifier]="childNotifier"
          ></app-widget-card>
      </div>

      <div>
        <app-widget-card
          [dateFrom] ="dateFrom"
          [dateTo]   ="dateTo"
          groupBy    ="orderemployeesales"
          chartName  ="Employee Order Sales"
          [sites]    ="sites"
          [counter]  ="count+1"
          [notifier]="childNotifier"
        ></app-widget-card>
      </div>
    </div>
  </div>

</ng-template>

<ng-template #emailing>
  <div class="emailing" *ngIf="emailSending">
    <mat-spinner [diameter]="50"></mat-spinner>
    ...emailing
  </div>
</ng-template>

<ng-template #metrcNetSalesSummary let-site>
    <app-metrc-summary
        [site]    ="site"
        [dateFrom]="dateFrom"
        [dateTo]  ="dateTo"
        [type]    ="'metrcSummary'"
        [counter]  ="count+1"
        [notifier]="childNotifier"  >
    <div summary>
      <mat-icon >receipt</mat-icon> {{site?.name}} METRC:
    </div>
  </app-metrc-summary>
</ng-template>



