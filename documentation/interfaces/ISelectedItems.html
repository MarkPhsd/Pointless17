<!doctype html>
<html class="no-js" lang="">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="x-ua-compatible" content="ie=edge">
        <title>pointless documentation</title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <link rel="icon" type="image/x-icon" href="../images/favicon.ico">
	   <link rel="stylesheet" href="../styles/style.css">
        <link rel="stylesheet" href="../styles/dark.css">
    </head>
    <body>

        <div class="navbar navbar-default navbar-fixed-top d-block d-sm-none">
            <a href="../" class="navbar-brand">pointless documentation</a>
            <button type="button" class="btn btn-default btn-menu ion-ios-menu" id="btn-menu"></button>
        </div>

        <div class="xs-menu menu" id="mobile-menu">
                <div id="book-search-input" role="search"><input type="text" placeholder="Type to search"></div>            <compodoc-menu></compodoc-menu>
        </div>

        <div class="container-fluid main">
           <div class="row main">
               <div class="hidden-xs menu">
                   <compodoc-menu mode="normal"></compodoc-menu>
               </div>
               <!-- START CONTENT -->
               <div class="content interface">
                   <div class="content-data">













<ol class="breadcrumb">
  <li class="breadcrumb-item">Interfaces</li>
  <li class="breadcrumb-item"
  >
  ISelectedItems</li>
</ol>

<ul class="nav nav-tabs" role="tablist">
        <li class="nav-item">
            <a href="#info" 
                class="nav-link"
                class="nav-link active"
                role="tab" id="info-tab" data-bs-toggle="tab" data-link="info">Info</a>
        </li>
        <li class="nav-item">
            <a href="#source" 
                class="nav-link"
                
                role="tab" id="source-tab" data-bs-toggle="tab" data-link="source">Source</a>
        </li>
</ul>

<div class="tab-content">
    <div class="tab-pane fade active in" id="info">
        <p class="comment">
            <h3>File</h3>
        </p>
        <p class="comment">
            <code>src/app/modules/posorders/pos-payment/possplit-items/possplit-items.component.ts</code>
        </p>




        <section data-compodoc="block-index">
            <h3 id="index">Index</h3>
            <table class="table table-sm table-bordered index-table">
                <tbody>
                    <tr>
                        <td class="col-md-4">
                            <h6><b>Properties</b></h6>
                        </td>
                    </tr>
                    <tr>
                        <td class="col-md-4">
                            <ul class="index-list">
                                <li>
                                        <a href="#groupID" 
>
                                            groupID
                                        </a>
                                </li>
                                <li>
                                        <a href="#id" 
>
                                            id
                                        </a>
                                </li>
                                <li>
                                        <a href="#name" 
>
                                            name
                                        </a>
                                </li>
                            </ul>
                        </td>
                    </tr>
                </tbody>
            </table>
        </section>



            <section data-compodoc="block-properties">
                <h3 id="inputs">Properties</h3>
                    <table class="table table-sm table-bordered">
                        <tbody>
                                <tr>
                                    <td class="col-md-4">
                                        <a name="groupID"></a>
                                        <span class="name "><b>groupID</b>
                                            <a href="#groupID">
                                                <span class="icon ion-ios-link"></span>
                                            </a>
                                        </span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="col-md-4">
                                        <code>groupID:         <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/number" target="_blank" >number</a></code>
</code>
                                    </td>
                                </tr>


                                    <tr>
                                        <td class="col-md-4">
                                            <i>Type : </i>        <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/number" target="_blank" >number</a></code>

                                        </td>
                                    </tr>





                        </tbody>
                    </table>
                    <table class="table table-sm table-bordered">
                        <tbody>
                                <tr>
                                    <td class="col-md-4">
                                        <a name="id"></a>
                                        <span class="name "><b>id</b>
                                            <a href="#id">
                                                <span class="icon ion-ios-link"></span>
                                            </a>
                                        </span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="col-md-4">
                                        <code>id:         <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/number" target="_blank" >number</a></code>
</code>
                                    </td>
                                </tr>


                                    <tr>
                                        <td class="col-md-4">
                                            <i>Type : </i>        <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/number" target="_blank" >number</a></code>

                                        </td>
                                    </tr>





                        </tbody>
                    </table>
                    <table class="table table-sm table-bordered">
                        <tbody>
                                <tr>
                                    <td class="col-md-4">
                                        <a name="name"></a>
                                        <span class="name "><b>name</b>
                                            <a href="#name">
                                                <span class="icon ion-ios-link"></span>
                                            </a>
                                        </span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="col-md-4">
                                        <code>name:         <code><a href="../miscellaneous/variables.html#s" target="_self" >string</a></code>
</code>
                                    </td>
                                </tr>


                                    <tr>
                                        <td class="col-md-4">
                                            <i>Type : </i>        <code><a href="../miscellaneous/variables.html#s" target="_self" >string</a></code>

                                        </td>
                                    </tr>





                        </tbody>
                    </table>
            </section>
    </div>


    <div class="tab-pane fade  tab-source-code" id="source">
        <pre class="line-numbers compodoc-sourcecode"><code class="language-typescript">import { Component, OnInit, EventEmitter, Input, Output, HostListener } from &#x27;@angular/core&#x27;;
import { UntypedFormBuilder, UntypedFormGroup } from &#x27;@angular/forms&#x27;;
import { moveItemInArray, CdkDragDrop, transferArrayItem } from &#x27;@angular/cdk/drag-drop&#x27;;
import { IListBoxItem, IItemsMovedEvent } from &#x27;src/app/_interfaces/dual-lists&#x27;;
import { map, Observable, of, switchMap} from &#x27;rxjs&#x27;;
import { IItemBasic, IItemBasicB } from &#x27;src/app/_services/menu/menu.service&#x27;;
import { SitesService } from &#x27;src/app/_services/reporting/sites.service&#x27;;
import { OrdersService } from &#x27;src/app/_services&#x27;;
import { IPOSOrder, PosOrderItem } from &#x27;src/app/_interfaces/transactions/posorder&#x27;;
import { MatSnackBar } from &#x27;@angular/material/snack-bar&#x27;;
import { PrintingService } from &#x27;src/app/_services/system/printing.service&#x27;;
import { group } from &#x27;console&#x27;;
import { OrderMethodsService } from &#x27;src/app/_services/transactions/order-methods.service&#x27;;

export interface   ISelectedItems{
  id        : number;
  name      : string;
  groupID   : number;
}

@Component({
  selector: &#x27;app-possplit-items&#x27;,
  templateUrl: &#x27;./possplit-items.component.html&#x27;,
  styleUrls: [&#x27;./possplit-items.component.scss&#x27;]
})
export class POSSplitItemsComponent implements OnInit {

    smallDevice         &#x3D; false;
    @Output() outPutPaymentAmount &#x3D; new EventEmitter();
    @Input() order   : IPOSOrder;
    order$: Observable&lt;IPOSOrder&gt;;
    saveAssignedItems$: Observable&lt;any&gt;;
    productTypes$    : Observable&lt;IItemBasicB[]&gt;;
    orderItems       : PosOrderItem[];
    productTypes     : IItemBasic[];
    orderGroupTotal$ : Observable&lt;IPOSOrder&gt;;

    typeID           : number;
    assignedStatic   : any;
    allAssigned      : any;
    itemID           : number;
    currentGroupID   &#x3D; 1;
    currentGroup     &#x3D; &#x27;1&#x27;;
    selectedItems$   : Observable&lt;any&gt;
    allitems$        : Observable&lt;any&gt;
    changesOcurred   &#x3D; false;
    savingChanges    : boolean;
    transferAllowed  : boolean;

    values  &#x3D;
      [
        {id:0,name: 0},
        {id:1,name: 1},
        {id:2,name: 2},
        {id:3,name: 3},
        {id:4,name: 4},
        {id:5,name: 5},
        {id:6,name: 6},
        {id:7,name: 7},
        {id:8,name: 8},
        {id:9,name: 9},
    ]

    // array of items to display in left box
    @Input() set availables(items: Array&lt;{}&gt;) {
      this.availableItems &#x3D; [...(items || []).map((item: {}, index: number) &#x3D;&gt; ({
        value: item[this.valueField].toString(),
        text: item[this.textField],
        groupID: item[this.currentGroupID]
      }))];
    }

    // array of items to display in right box
    @Input() set selects(items: Array&lt;{}&gt;) {
      this.selectedItems &#x3D; [...(items || []).map((item: {}, index: number) &#x3D;&gt; ({
        value: item[this.valueField].toString(),
        text: item[this.textField],
        groupID: item[this.currentGroupID]
      }))];
    }

    // field to use for value of option
    @Input() valueField &#x3D; &#x27;id&#x27;;
    // field to use for displaying option text
    @Input() textField &#x3D; &#x27;name&#x27;;
    // text displayed over the available items list box
    @Input() availableText &#x3D; &#x27;Available items&#x27;;
    // text displayed over the selected items list box
    @Input() selectedText &#x3D; &#x27;Selected items&#x27;;
    // set placeholder text in available items list box
    @Input() availableFilterPlaceholder &#x3D; &#x27;Filter...&#x27;;
    // set placeholder text in selected items list box
    @Input() selectedFilterPlaceholder &#x3D; &#x27;Filter...&#x27;;
    // event called when items are moved between boxes, returns state of both boxes and item moved
    @Output() itemsMoved: EventEmitter&lt;IItemsMovedEvent&gt; &#x3D; new EventEmitter&lt;IItemsMovedEvent&gt;();

    availableItems: Array&lt;IListBoxItem&gt; &#x3D; [];
    selectedItems : Array&lt;IListBoxItem&gt; &#x3D; [];
    listBoxForm   : UntypedFormGroup;

    filterGroup(item: PosOrderItem, groupValue: number) {
      if (!item.splitGroupID) return false;
      return item.splitGroupID &#x3D;&#x3D; groupValue;
    }

    subscriber() {
      this.orderMethodsService.currentOrder$.subscribe(data &#x3D;&gt; {
        if (data) {
          this.order &#x3D; data;
        }
      })
    }

    constructor(
      private siteService: SitesService,
      private orderService: OrdersService,
      public orderMethodsService: OrderMethodsService,
      public printingService: PrintingService,
      private matSnack   : MatSnackBar,
      public fb: UntypedFormBuilder) {
      this.listBoxForm &#x3D; this.fb.group({
        availableSearchInput: [&#x27;&#x27;],
        selectedSearchInput:  [&#x27;&#x27;],
      });
    }

    @HostListener(&quot;window:resize&quot;, [])
    updateItemsPerPage() {
      this.smallDevice &#x3D; false
      if (window.innerWidth &lt; 768) {
        this.smallDevice &#x3D; true
      }
      if (!this.smallDevice) {
      }
    }

    ngOnInit() {
      this.updateItemsPerPage()
      const site &#x3D; this.siteService.getAssignedSite()
      this.initGroupList();
      this.applyGroupID(0);
      this.setGroupOrderTotal(site, this.order.id, 0)

      this.refreshOrder();
    }

    initGroupList(): any {
      if (this.order &amp;&amp; this.order.posOrderItems) {
        const result &#x3D; this.order.posOrderItems.filter(data &#x3D;&gt; {
          return data.idRef &#x3D;&#x3D; data.id;
        })
        return this.removeSelectedFromAvailable(result, 0)
      }
    }

    applyGroupID(event) {
      if (event) {
        this.currentGroupID &#x3D; event.id;
        this.currentGroup   &#x3D; event.id.toString()
        this.changesOcurred &#x3D; false;
        this.refreshAssignedItems();
      }
    }

    removeSelectedFromAvailable( orderItems: PosOrderItem[], groupID: number): IListBoxItem[]   {
      let allItems &#x3D; orderItems.map( item &#x3D;&gt; (
          { value  : item.id.toString(),
            text   : item.productName,
            groupID: item.splitGroupID }
        )
      );

      this.availableItems &#x3D; allItems.filter( x &#x3D;&gt; {
          if ( x.groupID &#x3D;&#x3D; 0 || x.groupID &#x3D;&#x3D; undefined  || x.groupID &#x3D;&#x3D; null ) {
            return x;
          }
        }
      )

      const assignedItems &#x3D; allItems.filter( x &#x3D;&gt; {
        if ( x.groupID !&#x3D; 0 &amp;&amp; x.groupID !&#x3D; undefined &amp;&amp; x.groupID !&#x3D; null ) {
          return x;
        }
      })

      // console.log(&#x27;assignedItems&#x27; , assignedItems)
      return assignedItems;
    }

    setAvalibleItems(orderItems: PosOrderItem[]) {

    }

    convertTolistBoxItem(listSource: any[]): IListBoxItem[] {
      return listSource.map(item &#x3D;&gt; (
        { value: item.id.toString(),
          text: item.name,
          groupID: item.splitGroupID
        })
      );
    }

    //we are saving the Whole List of assigned or
    //we are saving the added.
    // i feel like it&#x27;s easier to push the whole list,
    //and keep a reference to the selecteditems, then push the whole list.
    saveAssignedCategories(selected: IListBoxItem[]) {
      // if (selected) {
        // if (selected.length     &#x3D;&#x3D; 0)  { return   }

        const site           &#x3D; this.siteService.getAssignedSite();
        const items$         &#x3D; this.orderService.applyItemsToGroup(site, this.currentGroupID, selected);
        const assignedItems$ &#x3D; this.orderService.applyItemsToGroup(site, 0, this.availableItems)

        this.saveAssignedItems$ &#x3D; items$.pipe(
          switchMap(data &#x3D;&gt; {
            return assignedItems$
          })).pipe(
            switchMap(data &#x3D;&gt; {
            if (data) {
              this.setGroupOrderTotal(site, this.order.id, this.currentGroupID)
              this.changesOcurred &#x3D; false;
              this.savingChanges &#x3D; false
            }
            return  this.orderService.getOrder(site, this.order.id.toString() , false)
        })).pipe(
          switchMap(data &#x3D;&gt; {
          this.orderMethodsService.updateOrder(data);
          return of(data)
        }));

      console.log(&#x27;selected&#x27;, selected)
    }

    setGroupOrderTotal(site, orderID, groupID) {
      this.orderGroupTotal$ &#x3D; this.orderService.getPOSOrderGroupTotal(site, orderID, groupID).pipe(
        switchMap(data &#x3D;&gt; {
          return of(data)
        })
      )
    }

    refreshOrder() {
      const site &#x3D; this.siteService.getAssignedSite()
      this.order$ &#x3D; this.orderService.getOrder(site, this.order.id.toString() , false).pipe(
        switchMap(data &#x3D;&gt; {
          this.orderMethodsService.updateOrder(data);
          return of(data)
      }))
    }

    submitPaymentAmount() {
      this.orderGroupTotal$.subscribe( data &#x3D;&gt; {
        if (!data) { return }
         this.outPutPaymentAmount.emit({amount: data.total.toFixed(2), groupID: this.currentGroupID})
      })
    }

    makePayment(event) {
      this.outPutPaymentAmount.emit(event)
    }

    refreshAssignedItems() {

      if (!this.order) return;
      if (!this.currentGroupID) { this.currentGroupID &#x3D; 0 };
      const site &#x3D; this.siteService.getAssignedSite();

      const selectedItems$  &#x3D; this.orderService.getSplitItemsList(site, this.order?.id, this.currentGroupID);

      this.orderGroupTotal$ &#x3D; selectedItems$.pipe(switchMap(data &#x3D;&gt; {
          this.selectedItems &#x3D; data
          return this.orderService.getOrder(site, this.order.id.toString(), false);
      })).pipe(switchMap(data &#x3D;&gt; {
        {
          this.orderMethodsService.updateOrder(data)
          return this.orderService.getPOSOrderGroupTotal(site, this.order.id, this.currentGroupID);
        }
      })).pipe(switchMap(data &#x3D;&gt; {
        return of(data)
      }));

    }

    refreshUnassignedItems() {
      const site &#x3D; this.siteService.getAssignedSite()
      this.allitems$ &#x3D; this.orderService.getSplitItemsList(site, this.order.id, 0).pipe(switchMap(data &#x3D;&gt; {
        this.availableItems &#x3D; data
        return of(data)
      }))
    }

    assignArrayToItemType(selected: IListBoxItem[]) {
      if (!this.selectedItems) { this.selectedItems &#x3D; [] };
      selected.forEach( data &#x3D;&gt; {
        this.selectedItems.push(data)
      });
      this.saveAssignedCategories(selected);
    }

    drop(event: CdkDragDrop&lt;IListBoxItem[]&gt;) {
      if (event.previousContainer &#x3D;&#x3D;&#x3D; event.container) {
        console.log(&#x27;moveItemInArray&#x27;)
        moveItemInArray(event.container.data, event.previousIndex, event.currentIndex);
      } else {
        console.log(&#x27;transferArrayItem&#x27;)
        transferArrayItem(event.previousContainer.data, event.container.data, event.previousIndex, event.currentIndex);
      }

      // clear marked available items and emit event
      this.itemsMoved.emit({
        available: this.availableItems,
        selected: this.selectedItems,
        movedItems: event.container.data.filter((v, i) &#x3D;&gt; i &#x3D;&#x3D;&#x3D; event.currentIndex),
        from: &#x27;available&#x27;,
        to: &#x27;selected&#x27;,
      });

      this.availableItems.forEach(data &#x3D;&gt; {  data.groupID &#x3D; 0; })

      this.selectedItems.forEach(data &#x3D;&gt; { data.groupID &#x3D; this.currentGroupID; });
      this.changesOcurred &#x3D; true;
    }

    dropToList(event: CdkDragDrop&lt;IListBoxItem[]&gt;, index: number) {
      if (event.previousContainer &#x3D;&#x3D;&#x3D; event.container) {
        moveItemInArray(event.container.data, event.previousIndex, event.currentIndex);
      } else {
        transferArrayItem(event.previousContainer.data, event.container.data, event.previousIndex, event.currentIndex);
      }

      // clear marked available items and emit event
      this.itemsMoved.emit({
        available: this.availableItems,
        selected: this.selectedItems,
        movedItems: event.container.data.filter((v, i) &#x3D;&gt; i &#x3D;&#x3D;&#x3D; event.currentIndex),
        from: &#x27;available&#x27;,
        to: &#x27;selected&#x27;,
      });

      this.availableItems.forEach(data &#x3D;&gt; {  data.groupID &#x3D; 0; })
      this.selectedItems.forEach(data &#x3D;&gt; { data.groupID &#x3D; this.currentGroupID; });
      this.changesOcurred &#x3D; true;
    }

    saveChanges() {
      if (!this.order) return;
      const paymentsMade  &#x3D; this.order.balanceRemaining.toFixed(2 )&#x3D;&#x3D; this.order.total.toFixed(2);
      if (!paymentsMade) {
        this.matSnack.open(&#x60;Unable to save, payments have been applied. Apply payments based on normal procedures.
                            Balance is: ${this.order?.balanceRemaining} and total is ${this.order?.total}&#x60;, &#x27;Alert&#x27;);
        this.changesOcurred &#x3D; false;
        this.savingChanges &#x3D; false;
        return;
      }
      this.savingChanges &#x3D; true
      this.saveAssignedCategories(this.selectedItems);
    }

}


</code></pre>
    </div>
</div>








                   </div><div class="search-results">
    <div class="has-results">
        <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
        <ul class="search-results-list"></ul>
    </div>
    <div class="no-results">
        <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
    </div>
</div>
</div>
               <!-- END CONTENT -->
           </div>
       </div>

          <label class="dark-mode-switch">
               <input type="checkbox">
               <span class="slider">
                    <svg class="slider-icon" viewBox="0 0 24 24" fill="none" height="20" stroke="#000" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" width="20" xmlns="http://www.w3.org/2000/svg">
                    <path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"></path>
                    </svg>
               </span>
          </label>

       <script>
            var COMPODOC_CURRENT_PAGE_DEPTH = 1;
            var COMPODOC_CURRENT_PAGE_CONTEXT = 'interface';
            var COMPODOC_CURRENT_PAGE_URL = 'ISelectedItems.html';
            var MAX_SEARCH_RESULTS = 15;
       </script>

       <script src="../js/libs/custom-elements.min.js"></script>
       <script src="../js/libs/lit-html.js"></script>

       <script src="../js/menu-wc.js" defer></script>
       <script nomodule src="../js/menu-wc_es5.js" defer></script>

       <script src="../js/libs/bootstrap-native.js"></script>

       <script src="../js/libs/es6-shim.min.js"></script>
       <script src="../js/libs/EventDispatcher.js"></script>
       <script src="../js/libs/promise.min.js"></script>
       <script src="../js/libs/zepto.min.js"></script>

       <script src="../js/compodoc.js"></script>

       <script src="../js/tabs.js"></script>
       <script src="../js/menu.js"></script>
       <script src="../js/libs/clipboard.min.js"></script>
       <script src="../js/libs/prism.js"></script>
       <script src="../js/sourceCode.js"></script>
          <script src="../js/search/search.js"></script>
          <script src="../js/search/lunr.min.js"></script>
          <script src="../js/search/search-lunr.js"></script>
          <script src="../js/search/search_index.js"></script>
       <script src="../js/lazy-load-graphs.js"></script>


    </body>
</html>
